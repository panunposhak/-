<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Collection | Panun Poshak</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- FIXED: SMOOTH PAGE LOAD --- */
        /* Removed animation from BODY to fix Bottom Bar scrolling issue */
        body { 
            background-color: #050505;
        }

        /* Apply animation to content blocks only */
        header, .filter-container, .shop-container, .custom-footer {
            opacity: 0; 
            animation: pageFadeIn 0.8s ease forwards; 
        }
        
        @keyframes pageFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .product-card {
            opacity: 0; 
            animation: cardPopIn 0.6s ease forwards;
        }
        
        /* Staggered animation for grid items */
        .product-card:nth-child(1) { animation-delay: 0.1s; }
        .product-card:nth-child(2) { animation-delay: 0.15s; }
        .product-card:nth-child(3) { animation-delay: 0.2s; }
        .product-card:nth-child(4) { animation-delay: 0.25s; }
        .product-card:nth-child(5) { animation-delay: 0.3s; }
        .product-card:nth-child(6) { animation-delay: 0.35s; }

        @keyframes cardPopIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- OPTION 3: HIGH CONTRAST GOLD BANNER --- */
        .announcement-bar {
            background: #C5A059; 
            color: #000000;       
            border-bottom: 1px solid #000; 
            height: 48px; width: 100%; position: fixed; top: 0; left: 0; z-index: 9000; 
            display: none; justify-content: center; align-items: center;
            font-family: 'Playfair Display', serif; font-size: 0.9rem; letter-spacing: 1px;
            text-transform: uppercase; font-weight: 700; 
        }

        .fade-msg { opacity: 0; transform: translateY(5px); transition: opacity 0.8s ease, transform 0.8s ease; }
        .fade-msg.active { opacity: 1; transform: translateY(0); }

        /* --- LAYOUT FIXES --- */
        body.has-banner { padding-top: 48px !important; }
        
        header { 
            position: relative !important; 
            top: 0; 
            width: 100%; 
            background: #050505; 
            z-index: 100;
            padding-bottom: 10px;
        }

        .shop-container { padding-top: 20px; min-height: 60vh; }
        @media (max-width: 768px) { .shop-container { padding-top: 20px; } }

        .filter-container {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
        }

        /* --- PREMIUM CART OVERRIDES (FIXED HEIGHT) --- */
        .cart-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 10000; opacity: 0; pointer-events: none; transition: 0.4s ease; }
        .cart-overlay.open { opacity: 1; pointer-events: auto; }
        
        .cart-drawer { 
            position: fixed; top: 0; right: -450px; 
            width: 100%; max-width: 420px; 
            height: 100dvh; 
            background: rgba(15, 15, 15, 0.95); border-left: 1px solid rgba(197, 160, 89, 0.3); 
            z-index: 10001; 
            transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); 
            display: flex; flex-direction: column; 
            box-shadow: -10px 0 40px rgba(0,0,0,0.8); 
        }
        .cart-drawer.open { right: 0; }
        
        .cart-header { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .cart-header h2 { font-family: 'Playfair Display', serif; color: #C5A059; margin: 0; font-size: 1.8rem; }
        .close-cart { background: none; border: none; color: #888; font-size: 2rem; cursor: pointer; transition: 0.2s; line-height: 1; }
        .close-cart:hover { color: white; transform: rotate(90deg); }
        
        .cart-items { flex: 1; overflow-y: auto; padding: 25px; }
        .cart-items::-webkit-scrollbar { width: 4px; }
        .cart-items::-webkit-scrollbar-thumb { background: #333; }
        
        .c-item { display: flex; gap: 15px; margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; transition: 0.3s; }
        .c-item:hover { background: rgba(255,255,255,0.05); border: 1px solid rgba(197, 160, 89, 0.1); }
        .c-img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; border: 1px solid #333; }
        .c-details { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .c-name { color: #eee; font-size: 0.95rem; margin: 0; font-weight: 500; }
        .c-price { color: #C5A059; font-size: 0.9rem; font-family: 'Playfair Display', serif; }
        .c-controls { display: flex; align-items: center; justify-content: space-between; margin-top: 5px; }
        .qty-mini { display: flex; align-items: center; background: #000; border: 1px solid #333; border-radius: 50px; padding: 2px; }
        .qty-mini button { width: 24px; height: 24px; border-radius: 50%; border: none; background: #222; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .qty-mini button:hover { background: #C5A059; color: black; }
        .qty-mini span { padding: 0 10px; font-size: 0.85rem; font-weight: bold; color: white; min-width: 20px; text-align: center;}
        .del-btn { color: #666; font-size: 1rem; cursor: pointer; background: none; border: none; transition: 0.2s; }
        .del-btn:hover { color: #ff4d4d; transform: scale(1.1); }
        
        .cart-footer { 
            padding: 25px; 
            border-top: 1px solid rgba(255,255,255,0.05); 
            background: #0a0a0a; 
            flex-shrink: 0;
            padding-bottom: 40px; 
        }
        
        .coupon-section { margin-bottom: 20px; display: flex; gap: 8px; }
        .coupon-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; padding: 10px 15px; border-radius: 8px; outline: none; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; }
        .coupon-input:focus { border-color: #C5A059; }
        .coupon-btn { background: transparent; border: 1px solid #C5A059; color: #C5A059; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.8rem; transition: 0.3s; }
        .coupon-btn:hover { background: #C5A059; color: black; }
        .cart-total-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: #aaa; }
        .cart-final-total { display: flex; justify-content: space-between; font-size: 1.4rem; color: white; font-weight: bold; margin-top: 15px; margin-bottom: 20px; border-top: 1px dashed #333; padding-top: 15px; font-family: 'Playfair Display', serif; }
        .checkout-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #C5A059 0%, #9e7f43 100%); color: black; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; text-transform: uppercase; box-shadow: 0 5px 20px rgba(197, 160, 89, 0.3); transition: 0.3s; }
        .checkout-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(197, 160, 89, 0.5); color: white; }

        /* ACCOUNT DRAWER */
        .account-drawer { position: fixed; top: 0; left: -450px; width: 100%; max-width: 400px; height: 100%; background: rgba(10, 10, 10, 0.98); border-right: 1px solid rgba(197, 160, 89, 0.3); z-index: 10001; transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; box-shadow: 10px 0 40px rgba(0,0,0,0.8); }
        .account-drawer.open { left: 0; }
        .acc-header { padding: 30px; background: linear-gradient(180deg, rgba(197,160,89,0.1) 0%, transparent 100%); border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center; position: relative; }
        .user-profile-pic { width: 70px; height: 70px; border-radius: 50%; border: 2px solid #C5A059; margin: 0 auto 15px; object-fit: cover; display: none; }
        .user-placeholder { width: 70px; height: 70px; border-radius: 50%; border: 1px dashed #666; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 2rem; }
        .google-btn { background: white; color: black; border: none; padding: 12px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px auto; transition: 0.3s; }
        .acc-tabs { display: flex; border-bottom: 1px solid #222; margin-top: 10px; }
        .acc-tab { flex: 1; padding: 15px; background: transparent; border: none; color: #666; cursor: pointer; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        .acc-tab.active { color: #C5A059; border-bottom: 2px solid #C5A059; background: rgba(197,160,89,0.05); }
        .acc-content { flex: 1; overflow-y: auto; padding: 20px; }
        .acc-section { display: none; animation: fadeIn 0.4s ease; }
        .acc-section.active { display: block; }
        
        .w-item { display: flex; gap: 15px; margin-bottom: 15px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; align-items: center; cursor: pointer; transition: 0.2s; }
        .w-item:hover { background: rgba(255,255,255,0.08); }
        .w-img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
        .w-info h4 { margin: 0; color: white; font-size: 0.9rem; }
        .w-info p { margin: 0; color: #C5A059; font-size: 0.8rem; }
        .w-btn { margin-left: auto; background: none; border: 1px solid #444; color: white; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .fav-btn-card { position: absolute; top: 10px; right: 10px; width: 35px; height: 35px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; transition: 0.3s; font-size: 1.2rem; }
        .fav-btn-card:hover { transform: scale(1.1); background: white; color: black; }
        .fav-btn-card.active { background: #C5A059; color: black; border-color: #C5A059; }

        .product-card { cursor: pointer; } 
        .p-info { text-align: center; padding-bottom: 20px; } 
        .p-info h3 { font-size: 1rem; letter-spacing: 0.5px; margin-top: 10px; }
        .p-info p { font-weight: bold; margin-top: 5px; font-size: 1.1rem; }
        .header-icon-btn { font-size: 1.4rem; color: white; cursor: pointer; transition: 0.3s; margin-right: 20px; display: flex; align-items: center; }
        .header-icon-btn:hover { color: #C5A059; }
        .logout-link { display: block; text-align: center; color: #666; font-size: 0.8rem; margin-top: 10px; text-decoration: underline; cursor: pointer; }

        /* --- NEW: AI BOT & WHATSAPP FLOATS --- */
        .chat-float {
            position: fixed; bottom: 100px; right: 20px; 
            width: 50px; height: 50px; background: #25D366;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 9000;
            transition: 0.3s; cursor: pointer; border: 2px solid white;
        }
        .chat-float:hover { transform: scale(1.1); }
        .chat-float svg { width: 26px; height: 26px; fill: white; }

        .ai-trigger {
            position: fixed; bottom: 160px; right: 20px; 
            width: 50px; height: 50px; background: #C5A059;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 9000;
            transition: 0.3s; cursor: pointer; border: 2px solid black;
            animation: bounce 2s infinite;
        }
        .ai-trigger:hover { transform: scale(1.1); }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .chat-window {
            position: fixed; bottom: 100px; right: 80px;
            width: 320px; height: 450px;
            background: rgba(15, 15, 15, 0.98); backdrop-filter: blur(15px);
            border: 1px solid #C5A059; border-radius: 20px;
            z-index: 10000; display: none; flex-direction: column;
            box-shadow: 0 10px 50px rgba(0,0,0,0.9);
            transform-origin: bottom right; animation: popIn 0.3s ease;
        }
        .chat-header {
            padding: 15px; background: #C5A059; color: black; font-weight: bold;
            border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center;
        }
        .chat-body {
            flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
        }
        .msg { padding: 10px 14px; border-radius: 12px; font-size: 0.85rem; max-width: 85%; line-height: 1.4; }
        .msg.bot { background: #222; color: #eee; align-self: flex-start; border: 1px solid #444; border-bottom-left-radius: 2px; }
        .msg.user { background: #C5A059; color: black; align-self: flex-end; border-bottom-right-radius: 2px; font-weight: 500; }
        
        .chat-footer { padding: 10px; border-top: 1px solid #333; display: flex; gap: 5px; background: #111; }
        .chat-input { flex: 1; background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 20px; outline: none; font-size: 0.9rem; }
        .chat-send { background: #C5A059; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; color: black; font-weight: bold; }

        .chat-chips { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .chip { background: rgba(197, 160, 89, 0.2); border: 1px solid #C5A059; color: #C5A059; padding: 5px 10px; border-radius: 15px; font-size: 0.75rem; cursor: pointer; transition: 0.2s; }
        .chip:hover { background: #C5A059; color: black; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* --- CUSTOM LUXURY FOOTER --- */
        .custom-footer {
            background-color: #000;
            padding: 60px 20px 40px;
            text-align: center;
            border-top: 1px solid #111;
            position: relative;
            overflow: hidden;
        }

        .footer-logo-container {
            position: relative;
            display: inline-block;
            margin-bottom: 30px;
        }

        .footer-logo {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: #C5A059;
            letter-spacing: 2px;
            margin: 0;
            position: relative;
            z-index: 2;
        }

        .footer-logo-circle {
            position: absolute;
            top: -10px;
            right: -20px;
            width: 60px;
            height: 60px;
            border: 1px solid rgba(197, 160, 89, 0.5);
            border-radius: 50%;
            z-index: 1;
            pointer-events: none;
        }

        .footer-nav {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .footer-link {
            color: #999;
            text-decoration: none;
            font-family: sans-serif;
            font-size: 0.75rem;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            transition: 0.3s ease;
        }

        .footer-link:hover {
            color: #C5A059;
        }

        .footer-divider {
            width: 40px;
            height: 1px;
            background-color: #333;
            margin: 0 auto 30px;
        }

        .footer-copyright {
            color: #555;
            font-size: 0.7rem;
            line-height: 1.6;
            font-family: sans-serif;
        }

        @media (max-width: 768px) {
            .footer-nav { gap: 20px; flex-direction: column; }
            .footer-logo { font-size: 2rem; }
        }

        /* --- FIXED: BOTTOM BAR FIX --- */
        .bottom-bar {
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 85%; max-width: 350px;
            background: rgba(20, 20, 20, 0.8); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50px; 
            padding: 12px 30px; 
            display: flex; justify-content: space-between; align-items: center;
            z-index: 9000; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .bar-item { display: flex; flex-direction: column; align-items: center; color: #ccc; font-size: 1.2rem; text-decoration: none; }
        .bar-item small { font-size: 0.6rem; margin-top: 3px; text-transform: uppercase; }
        .bar-item:hover { color: #C5A059; }
    </style>
</head>
<body>

    <div id="cursor-dot" class="cursor-dot" style="background: #C5A059; width: 6px; height: 6px; border-radius: 50%; position: fixed; pointer-events: none; z-index: 999999;"></div>
    <div id="cursor-outline" class="cursor-outline" style="border: 1px solid #C5A059; width: 40px; height: 40px; border-radius: 50%; position: fixed; pointer-events: none; z-index: 999999;"></div>

    <div id="announcement-bar" class="announcement-bar">
        <span id="announcement-text" class="fade-msg"></span>
    </div>

    <header>
        <div class="header-top">
            <div style="display: flex; align-items: center;">
                <div class="header-icon-btn" onclick="openAccountDrawer()">
                    üë§ <span style="font-size:0.7rem; margin-left:5px; text-transform:uppercase; letter-spacing:1px; display:none;" id="acc-label">Account</span>
                </div>
            </div>
            <a href="index.html" class="logo" style="margin-left: -40px;">PANUN POSHAK</a>
            <div style="display:flex; align-items:center;">
                <div class="header-icon-btn" style="margin-right:0;" onclick="openCartDrawer()">
                    üõí <span id="cart-count" style="font-size:0.8rem; background:#C5A059; color:black; padding:2px 6px; border-radius:50%; margin-left:5px;">0</span>
                </div>
            </div>
        </div>
        
        <div class="search-box" style="margin: 10px auto; width: 90%;">
            <input type="text" id="global-search" placeholder="Search Collection..." oninput="instantSearch()">
            <button onclick="runSearch()">üîç</button>
        </div>

        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="shop.html">Shop All</a>
            <a href="shop.html?q=pheran">Pherans</a>
            <a href="shop.html?q=shawl">Shawls</a>
            <a href="shop.html?q=bags">Bags</a>
            <a href="shop.html?q=men">Men</a>
            <a href="about.html">Our Story</a>
        </nav>
    </header>

    <div class="filter-container">
        <button onclick="window.location.href='shop.html'" class="filter-btn" id="btn-all">All</button>
        <button onclick="window.location.href='shop.html?q=clothing'" class="filter-btn" id="btn-clothing">Clothing</button>
        <button onclick="window.location.href='shop.html?q=bags'" class="filter-btn" id="btn-bags">Bags</button>
        <button onclick="window.location.href='shop.html?q=shawl'" class="filter-btn" id="btn-shawl">Shawls</button>
        <button onclick="window.location.href='shop.html?q=accessories'" class="filter-btn" id="btn-accessories">Accessories</button>
    </div>

    <section class="shop-container">
        <h2 id="collection-title" style="text-align:center; color:#C5A059; font-family:'Playfair Display', serif; margin-bottom:30px;">Current Collection</h2>
        <div id="product-grid" class="product-grid">
            <p style="text-align:center; color:white; width:100%; grid-column:1/-1;">Loading Collection...</p>
        </div>
    </section>
    
    <footer class="custom-footer">
        <div class="footer-logo-container">
            <h2 class="footer-logo">PANUN POSHAK</h2>
            <div class="footer-logo-circle"></div>
        </div>

        <div class="footer-nav">
            <a href="about.html" class="footer-link">Our Story</a>
            <a href="https://wa.me/919103463033" class="footer-link">Whatsapp</a>
            <a href="https://instagram.com/panun._.poshak" class="footer-link">Instagram</a>
            <a href="mailto:poshakpanun@gmail.com" class="footer-link">Email Support</a>
        </div>

        <div class="footer-divider"></div>

        <div class="footer-copyright">
            &copy; 2026 Panun Poshak. Heritage Reimagined.<br>
            Made with <span style="color: #ff4d4d;">‚ù§Ô∏è</span> in Srinagar, Kashmir.
        </div>
    </footer>

    <a href="https://wa.me/919103463033" target="_blank" class="chat-float" title="WhatsApp Us">
        <svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.05 22L7.3 20.62C8.75 21.41 10.38 21.83 12.04 21.83C17.5 21.83 21.95 17.38 21.95 11.92C21.95 9.27 20.92 6.78 19.05 4.91C17.18 3.03 14.69 2 12.04 2M12.05 3.67C14.25 3.67 16.31 4.53 17.87 6.09C19.42 7.65 20.28 9.72 20.28 11.92C20.28 16.46 16.58 20.15 12.04 20.15C10.56 20.15 9.11 19.76 7.85 19L7.55 18.83L4.43 19.65L5.26 16.61L5.06 16.29C4.24 15 3.8 13.47 3.8 11.91C3.81 7.37 7.5 3.67 12.05 3.67Z"/></svg>
    </a>

    <div class="ai-trigger" onclick="toggleChat()">ü§ñ</div>

    <div class="chat-window" id="ai-chat">
        <div class="chat-header">
            <span>Panun Assistant</span>
            <span onclick="toggleChat()" style="cursor:pointer; font-size:1.2rem;">&times;</span>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="msg bot">Salaam! üëã I am the Panun Poshak Smart Assistant.<br>I can check order status, answer queries, or connect you to a human.</div>
            <div class="chat-chips">
                <div class="chip" onclick="botReply('track')">üì¶ Track Order</div>
                <div class="chip" onclick="botReply('shipping')">üöö Shipping info</div>
                <div class="chip" onclick="botReply('return')">üîÑ Returns</div>
                <div class="chip" onclick="botReply('human')">üë§ Talk to Human</div>
            </div>
        </div>
        <div class="chat-footer">
            <input type="text" id="chat-input" class="chat-input" placeholder="Type here..." onkeypress="handleChatKey(event)">
            <button class="chat-send" onclick="sendUserMessage()">‚û§</button>
        </div>
    </div>

    <div class="cart-overlay" id="account-overlay" onclick="closeAccountDrawer()"></div>
    <div class="account-drawer" id="account-drawer">
        <div class="acc-header">
            <button class="close-cart" onclick="closeAccountDrawer()" style="position: absolute; top: 15px; right: 15px;">&times;</button>
            <div id="auth-guest" style="display:block;">
                <div class="user-placeholder">üë§</div>
                <h2 style="font-size:1.5rem; margin:0; color:white;">Welcome</h2>
                <p style="margin:5px 0 15px 0; color:#888; font-size:0.8rem;">Join the Panun Poshak Family</p>
                <button onclick="googleLogin()" class="google-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> 
                    Sign in with Google
                </button>
            </div>
            <div id="auth-user" style="display:none;">
                <img src="" id="user-pic" class="user-profile-pic">
                <h2 id="user-name" style="font-size:1.3rem; margin:0; color:white;">User Name</h2>
                <p id="user-email" style="margin:5px 0 0 0; color:#888; font-size:0.7rem;">user@email.com</p>
                <span class="logout-link" onclick="logout()">Sign Out</span>
            </div>
        </div>

        <div class="acc-tabs">
            <button class="acc-tab active" onclick="switchTab('wishlist')">Favourites</button>
            <button class="acc-tab" onclick="switchTab('orders')">Orders</button>
            <button class="acc-tab" onclick="switchTab('tracker')">Track</button>
            <button class="acc-tab" onclick="switchTab('support')">Help</button>
        </div>
        <div class="acc-content">
            <div id="tab-wishlist" class="acc-section active">
                <div id="wishlist-items">
                    <p style="color:#666; text-align:center; margin-top:20px;">Your favourites list is empty.</p>
                </div>
            </div>

            <div id="tab-orders" class="acc-section">
                <div id="order-history-list">
                    <p style="color:#666; text-align:center; margin-top:20px;">
                        <span style="display:block; font-size:2rem;">üì¶</span>
                        Sign in to view orders linked to your email.
                    </p>
                </div>
            </div>

            <div id="tab-tracker" class="acc-section">
                <p style="color:#ccc; font-size:0.9rem; margin-bottom:15px;">Track your recent purchase.</p>
                <input type="text" id="mini-track-input" placeholder="Order ID (e.g. #A1B2C3)" style="width:100%; padding:10px; margin-bottom:10px; background:#222; border:1px solid #444; color:white; border-radius:5px;">
                <button onclick="miniTrack()" style="width:100%; padding:12px; background:#C5A059; color:black; font-weight:bold; border:none; cursor:pointer; border-radius:5px;">TRACK NOW</button>
            </div>

            <div id="tab-support" class="acc-section">
                <a href="https://wa.me/919103463033" target="_blank" style="display:block; padding:15px; background:#25D366; color:white; text-align:center; border-radius:10px; text-decoration:none; font-weight:bold; margin-bottom:15px;">Chat on WhatsApp</a>
                <a href="mailto:poshakpanun@gmail.com" style="display:block; padding:15px; background:#333; color:white; text-align:center; border-radius:10px; text-decoration:none; font-weight:bold;">Email Support</a>
            </div>
        </div>
    </div>

    <div class="cart-overlay" id="cart-overlay" onclick="closeCartDrawer()"></div>
    <div class="cart-drawer" id="cart-drawer">
        <div class="cart-header">
            <h2>Your Bag</h2>
            <button class="close-cart" onclick="closeCartDrawer()">&times;</button>
        </div>
        <div class="cart-items" id="drawer-items"></div>
        <div class="cart-footer">
            <div class="coupon-section">
                <input type="text" id="coupon-code" class="coupon-input" placeholder="Coupon Code">
                <button onclick="applyCoupon()" class="coupon-btn">APPLY</button>
            </div>
            <div id="coupon-msg" style="font-size:0.8rem; color:#25D366; margin-bottom:10px; display:none;"></div>
            <div class="cart-total-row"><span>Subtotal</span><span id="subtotal-price">‚Çπ0</span></div>
            <div class="cart-total-row" id="discount-row" style="display:none; color:#C5A059;"><span>Discount</span><span id="discount-amount">-‚Çπ0</span></div>
            <div class="cart-final-total"><span>Total</span><span id="drawer-total" style="color:#C5A059;">‚Çπ0</span></div>
            <button onclick="goToCheckout()" class="checkout-btn">CHECKOUT SECURELY</button>
        </div>
    </div>

    <nav class="bottom-bar">
        <a href="index.html" class="bar-item">üè† <small>Home</small></a>
        <a href="tracker.html" class="bar-item">üöö <small>Track</small></a>
        <div class="bar-item" onclick="openCartDrawer()">
          üõí <span id="cart-count-bar" style="background:#C5A059; color:black; padding:2px 6px; border-radius:50%; font-size:0.8rem; position:absolute; top:5px; right:30px;">0</span>
          <small>Bag</small>
        </div>
    </nav>

    <script src="firebase-config.js"></script>
    <script>
        if (typeof firebase === 'undefined' || !firebase.apps.length) { console.error("Firebase not loaded!"); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        let allProducts = []; 
        let appliedDiscount = 0;
        let currentUser = null;
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

        window.onload = function() {
            initAuth(); 
            loadProducts();
            highlightActiveCategory();
            checkAnnouncement();
            
            const cursorDot = document.getElementById("cursor-dot");
            const cursorOutline = document.getElementById("cursor-outline");
            if(cursorDot && cursorOutline){
                window.addEventListener("mousemove", (e) => {
                    cursorDot.style.left = `${e.clientX}px`; cursorDot.style.top = `${e.clientY}px`;
                    cursorOutline.animate({ left: `${e.clientX}px`, top: `${e.clientY}px` }, { duration: 500, fill: "forwards" });
                });
            }
        };

        /* --- REAL AI BOT LOGIC --- */
        function toggleChat() {
            const chat = document.getElementById('ai-chat');
            chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendUserMessage();
        }

        function sendUserMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            addMsgToChat(text, 'user');
            input.value = "";
            processBotResponse(text);
        }

        function botReply(type) {
            let msg = "";
            if(type === 'track') msg = "I want to track my order.";
            else if(type === 'shipping') msg = "What are the shipping charges?";
            else if(type === 'return') msg = "What is the return policy?";
            else if(type === 'human') msg = "Connect me to a human.";
            
            addMsgToChat(msg, 'user');
            processBotResponse(msg);
        }

        function addMsgToChat(text, sender) {
            const body = document.getElementById('chat-body');
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            div.innerText = text;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        async function processBotResponse(input) {
            const lower = input.toLowerCase();
            const body = document.getElementById('chat-body');
            
            // Show typing indicator
            const typing = document.createElement('div');
            typing.className = 'msg bot';
            typing.innerText = '...';
            body.appendChild(typing);
            body.scrollTop = body.scrollHeight;

            let reply = "I'm sorry, I didn't understand. Try clicking one of the options above.";

            // 1. Check for Order ID pattern (#A1B2C3 or 8 chars)
            if (lower.startsWith("#") || (lower.length === 8 && !lower.includes(" "))) {
                let searchId = input.toUpperCase();
                if(!searchId.startsWith("#")) searchId = "#" + searchId;
                
                try {
                    const q = await db.collection("orders").where("trackingId", "==", searchId).get();
                    if (!q.empty) {
                        const o = q.docs[0].data();
                        reply = `Order ${searchId} found! \nStatus: ${o.status}\nItems: ${o.product}`;
                    } else {
                        reply = "I couldn't find an order with that ID. Please check and try again.";
                    }
                } catch (e) { reply = "Network error checking order."; }
            }
            // 2. Standard FAQs
            else if (lower.includes("track") || lower.includes("where")) {
                reply = "To track an order, please type your Order ID starting with # (e.g., #A1B2C3).";
            }
            else if (lower.includes("shipping") || lower.includes("cost")) {
                reply = "Shipping is FREE for Prepaid orders. For COD, it's ‚Çπ50 (Srinagar) or ‚Çπ120 (Rest of India).";
            }
            else if (lower.includes("return") || lower.includes("exchange")) {
                reply = "We accept returns within 7 days for defective items. Please contact support on WhatsApp.";
            }
            else if (lower.includes("human") || lower.includes("talk")) {
                reply = "Redirecting you to our WhatsApp Support...";
                setTimeout(() => { window.open('https://wa.me/919103463033', '_blank'); }, 2000);
            }

            // Remove typing and show reply
            setTimeout(() => {
                body.removeChild(typing);
                addMsgToChat(reply, 'bot');
            }, 800);
        }

        // --- INSTANT SEARCH ---
        function instantSearch() {
            const query = document.getElementById('global-search').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                (p.name && p.name.toLowerCase().includes(query)) || 
                (p.category && p.category.toLowerCase().includes(query)) ||
                (p.subCategory && p.subCategory.toLowerCase().includes(query))
            );
            document.getElementById("collection-title").innerText = query ? `Search Results` : `Current Collection`;
            renderGrid(filtered);
        }

        // --- AUTH ---
        function initAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('auth-guest').style.display = 'none';
                    document.getElementById('auth-user').style.display = 'block';
                    document.getElementById('user-name').innerText = user.displayName;
                    document.getElementById('user-email').innerText = user.email;
                    document.getElementById('user-pic').src = user.photoURL;
                    document.getElementById('user-pic').style.display = 'block';
                    document.querySelector('.user-placeholder').style.display = 'none';
                    syncFavorites(user.uid);
                    loadOrderHistory(user.email); 
                } else {
                    currentUser = null;
                    document.getElementById('auth-guest').style.display = 'block';
                    document.getElementById('auth-user').style.display = 'none';
                    favorites = JSON.parse(localStorage.getItem('favorites')) || [];
                    renderGrid(allProducts); 
                }
            });
        }
        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => alert("Login failed."));
        }
        function logout() {
            auth.signOut().then(() => location.reload());
        }

        // --- REAL ORDER HISTORY LOGIC ---
        function loadOrderHistory(email) {
            const container = document.getElementById('order-history-list');
            container.innerHTML = "<p style='color:#666; text-align:center; margin-top:20px;'>Loading orders...</p>";

            db.collection("orders").where("userEmail", "==", email).orderBy("timestamp", "desc").get()
            .then(snap => {
                container.innerHTML = "";
                if(snap.empty) {
                    container.innerHTML = `
                        <div style="text-align:center; color:#888; padding:20px;">
                            <p>No orders linked to ${email}</p>
                            <small>If you placed an order as Guest, use the Track tab.</small>
                        </div>`;
                    return;
                }

                snap.forEach(doc => {
                    const o = doc.data();
                    const date = o.timestamp ? new Date(o.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                    const statusColor = o.status === 'Shipped' ? '#C5A059' : (o.status === 'Delivered' ? '#25D366' : '#fff');
                    
                    container.innerHTML += `
                        <div class="w-item" style="display:block; cursor:default;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <strong style="color:#C5A059;">${o.trackingId || '#' + doc.id.slice(0,8).toUpperCase()}</strong>
                                <span style="color:${statusColor}; font-size:0.8rem;">${o.status}</span>
                            </div>
                            <p style="color:#ccc; font-size:0.85rem; margin:0;">${o.product}</p>
                            <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:0.8rem; color:#888;">
                                <span>${date}</span>
                                <span>‚Çπ${o.price}</span>
                            </div>
                        </div>
                    `;
                });
            }).catch(err => {
                console.error("Order load error:", err);
                if(err.code === 'failed-precondition') {
                     container.innerHTML = "<p style='color:#ff4d4d; text-align:center; font-size:0.8rem;'>System Indexing... Check back in 5 mins.</p>";
                }
            });
        }

        // --- FAVORITES ---
        function syncFavorites(uid) {
            db.collection('customers').doc(uid).get().then(doc => {
                let cloudFavs = [];
                if (doc.exists && doc.data().favorites) cloudFavs = doc.data().favorites;
                favorites = [...new Set([...favorites, ...cloudFavs])];
                localStorage.setItem('favorites', JSON.stringify(favorites));
                db.collection('customers').doc(uid).set({ favorites: favorites }, { merge: true });
                renderGrid(allProducts);
                renderWishlist();
            });
        }
        function toggleFav(e, id) {
            e.stopPropagation(); 
            const index = favorites.indexOf(id);
            if (index > -1) favorites.splice(index, 1); 
            else favorites.push(id); 
            localStorage.setItem('favorites', JSON.stringify(favorites));
            if (currentUser) db.collection('customers').doc(currentUser.uid).set({ favorites: favorites }, { merge: true });
            const btn = document.getElementById(`fav-btn-${id}`);
            if(btn) {
                btn.classList.toggle('active');
                btn.style.background = btn.classList.contains('active') ? '#C5A059' : 'rgba(0,0,0,0.6)';
            }
            if(document.getElementById('account-drawer').classList.contains('open')) renderWishlist();
        }
        function renderWishlist() {
            const container = document.getElementById('wishlist-items');
            container.innerHTML = "";
            if (favorites.length === 0) {
                container.innerHTML = "<p style='color:#666; text-align:center;'>Your favourites list is empty.</p>";
                return;
            }
            favorites.forEach(id => {
                const product = allProducts.find(p => p.id === id);
                if (product) {
                    let img = product.img || (product.images ? product.images[0] : '');
                    container.innerHTML += `
                        <div class="w-item" onclick="window.location.href='product.html?id=${product.id}'">
                            <img src="${img}" class="w-img">
                            <div class="w-info"><h4>${product.name}</h4><p>‚Çπ${product.price}</p></div>
                            <button class="w-btn" onclick="toggleFav(event, '${product.id}'); renderWishlist();">‚úï</button>
                        </div>`;
                }
            });
        }

        // --- UI ---
        function openAccountDrawer() {
            document.getElementById('account-overlay').classList.add('open');
            document.getElementById('account-drawer').classList.add('open');
            renderWishlist();
        }
        function closeAccountDrawer() {
            document.getElementById('account-overlay').classList.remove('open');
            document.getElementById('account-drawer').classList.remove('open');
        }
        function switchTab(tabName) {
            document.querySelectorAll('.acc-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.acc-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        function miniTrack() {
            const id = document.getElementById('mini-track-input').value;
            if(id) window.location.href = `tracker.html?id=${id}`;
        }

        // --- GRID ---
        function loadProducts() {
            db.collection("products").orderBy("timestamp", "desc").get().then((querySnapshot) => {
                allProducts = [];
                querySnapshot.forEach((doc) => { allProducts.push({ id: doc.id, ...doc.data() }); });
                const params = new URLSearchParams(window.location.search);
                const searchQuery = params.get('q'); 
                let filtered = allProducts;
                if (searchQuery) {
                    const lowerQ = searchQuery.toLowerCase();
                    filtered = allProducts.filter(p => (p.name && p.name.toLowerCase().includes(lowerQ)) || (p.category && p.category.toLowerCase().includes(lowerQ)));
                    document.getElementById("collection-title").innerText = `Results for "${searchQuery}"`;
                }
                updateCartCount(); 
                renderGrid(filtered);
            });
        }

        function renderGrid(products) {
            const grid = document.getElementById("product-grid");
            grid.innerHTML = "";
            if(products.length === 0) {
                grid.innerHTML = "<p style='grid-column:1/-1; text-align:center; padding:50px; color:#888;'>No products found.</p>";
                return;
            }
            products.forEach(product => {
                let displayImg = product.img;
                if(product.images && product.images.length > 0) displayImg = product.images[0];
                const isFav = favorites.includes(product.id) ? 'active' : '';
                let cardClass = 'product-card';
                let soldBadge = product.soldOut ? '<div class="sold-badge">SOLD OUT</div>' : '';
                if (product.soldOut) cardClass += ' sold-item';
                
                grid.innerHTML += `
                    <div class="${cardClass}" onclick="window.location.href='product.html?id=${product.id}'">
                        <div class="p-img-container">
                            <img src="${displayImg}" alt="${product.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/300?text=No+Image'">
                            ${product.sale ? '<div class="sale-badge">SALE</div>' : ''}
                            ${soldBadge}
                            <div id="fav-btn-${product.id}" class="fav-btn-card ${isFav}" onclick="toggleFav(event, '${product.id}')">‚ô•</div>
                        </div>
                        <div class="p-info">
                            <h3 style="margin:0; color:white;">${product.name}</h3>
                            <p style="margin:5px 0 0 0; color:#C5A059;">‚Çπ${Number(product.price).toLocaleString()}</p>
                        </div>
                    </div>
                `;
            });
        }

        function checkAnnouncement() {
            db.collection('settings').doc('announcement').get().then(doc => {
                if (doc.exists && doc.data().isActive) {
                    const bar = document.getElementById('announcement-bar');
                    const textSpan = document.getElementById('announcement-text');
                    const rawText = doc.data().text;
                    const messages = rawText.split('|').map(t => t.trim());
                    bar.style.display = 'flex';
                    document.body.classList.add('has-banner');
                    let msgIndex = 0;
                    function cycleText() {
                        textSpan.classList.remove('active');
                        setTimeout(() => {
                            textSpan.innerText = messages[msgIndex];
                            msgIndex = (msgIndex + 1) % messages.length; 
                            textSpan.classList.add('active');
                        }, 800); 
                    }
                    cycleText(); 
                    if(messages.length > 1) setInterval(cycleText, 4000); 
                }
            });
        }

        function highlightActiveCategory() {
            const params = new URLSearchParams(window.location.search);
            const q = params.get('q');
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if (!q) { document.getElementById('btn-all').classList.add('active'); } 
            else { const target = document.getElementById(`btn-${q}`); if(target) target.classList.add('active'); }
        }

        function runSearch() {
            const query = document.getElementById('global-search').value;
            if(query) window.location.href = `shop.html?q=${encodeURIComponent(query)}`;
        }
        
        function openCartDrawer() {
            const container = document.getElementById('drawer-items');
            container.innerHTML = "";
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            let subtotal = 0;
            if(cart.length === 0) {
                container.innerHTML = "<p style='color:#666; text-align:center; margin-top:50px;'>Your bag is empty.</p>";
                updatePrices(0);
            } else {
                const counts = {};
                cart.forEach(id => counts[id] = (counts[id] || 0) + 1);
                Object.keys(counts).forEach(id => {
                    const product = allProducts.find(p => p.id === id);
                    if(product) {
                        const itemTotal = Number(product.price) * counts[id];
                        subtotal += itemTotal;
                        let displayImg = product.img || (product.images ? product.images[0] : '');
                        container.innerHTML += `
                            <div class="c-item">
                                <img src="${displayImg}" class="c-img">
                                <div class="c-details">
                                    <div><h4 class="c-name">${product.name}</h4><span class="c-price">‚Çπ${Number(product.price).toLocaleString()}</span></div>
                                    <div class="c-controls">
                                        <div class="qty-mini">
                                            <button onclick="modifyCart('${id}', -1)">-</button><span>${counts[id]}</span><button onclick="modifyCart('${id}', 1)">+</button>
                                        </div>
                                        <button class="del-btn" onclick="removeFromCart('${id}')">‚úï</button>
                                    </div>
                                </div>
                            </div>`;
                    }
                });
                updatePrices(subtotal);
            }
            document.getElementById('cart-overlay').classList.add('open');
            document.getElementById('cart-drawer').classList.add('open');
        }

        // --- UPDATED REAL COUPON LOGIC (SAME AS CHECKOUT) ---
        async function applyCoupon() {
            const codeInput = document.getElementById("coupon-code");
            const code = codeInput.value.trim().toUpperCase();
            const msg = document.getElementById("coupon-msg");
            const btn = document.querySelector(".coupon-btn");

            if(!code) return;

            btn.innerText = "...";
            btn.disabled = true;
            msg.style.display = "none";

            try {
                // Check Firebase
                const doc = await db.collection("coupons").doc(code).get();
                
                if(doc.exists) {
                    const data = doc.data();
                    appliedDiscount = data.percent;
                    msg.innerText = `‚úì ${code} Applied! (${appliedDiscount}% OFF)`;
                    msg.style.color = "#25D366";
                    msg.style.display = "block";
                } else {
                    appliedDiscount = 0;
                    msg.innerText = "‚ùå Invalid Coupon Code";
                    msg.style.color = "#ff4d4d";
                    msg.style.display = "block";
                }
            } catch (error) {
                console.error("Coupon check failed", error);
                msg.innerText = "Error checking coupon";
                msg.style.color = "#ff4d4d";
                msg.style.display = "block";
            }

            btn.innerText = "APPLY";
            btn.disabled = false;
            
            // Refresh to update prices
            openCartDrawer(); 
        }

        function updatePrices(subtotal) {
            document.getElementById("subtotal-price").innerText = "‚Çπ" + subtotal.toLocaleString();
            if(appliedDiscount > 0) {
                const discountVal = (subtotal * appliedDiscount) / 100;
                document.getElementById("discount-row").style.display = "flex";
                document.getElementById("discount-amount").innerText = "-‚Çπ" + discountVal.toLocaleString();
                document.getElementById("drawer-total").innerText = "‚Çπ" + (subtotal - discountVal).toLocaleString();
                localStorage.setItem("cart_discount_percent", appliedDiscount);
            } else {
                document.getElementById("discount-row").style.display = "none";
                document.getElementById("drawer-total").innerText = "‚Çπ" + subtotal.toLocaleString();
                localStorage.setItem("cart_discount_percent", 0);
            }
        }

        function closeCartDrawer() {
            document.getElementById('cart-overlay').classList.remove('open');
            document.getElementById('cart-drawer').classList.remove('open');
        }

        function modifyCart(id, change) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            if(change === 1) cart.push(id);
            else { const index = cart.indexOf(id); if(index > -1) cart.splice(index, 1); }
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartCount();
            openCartDrawer();
        }

        function removeFromCart(id) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            cart = cart.filter(itemId => itemId !== id);
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartCount();
            openCartDrawer();
        }

        function updateCartCount() {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            const count = cart.length;
            if(document.getElementById("cart-count")) document.getElementById("cart-count").innerText = count;
            if(document.getElementById("cart-count-bar")) document.getElementById("cart-count-bar").innerText = count;
        }

        function goToCheckout() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            if(cart.length === 0) return alert("Cart is empty");
            localStorage.setItem("checkout_type", "cart");
            window.location.href = "checkout.html";
        }
    </script>
</body>
</html>
