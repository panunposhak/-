<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin | Panun Poshak</title>
    
    <style>
        body { background: #050505; color: white; padding: 40px; font-family: 'Helvetica Neue', sans-serif; margin: 0; min-height: 100vh; }
        
        /* HIDE BODY UNTIL AUTH IS VERIFIED */
        #admin-container { display: none; }
        #loading-screen { display: flex; height: 100vh; justify-content: center; align-items: center; flex-direction: column; color: #C5A059; }

        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        h1 { color: #C5A059; font-family: 'Playfair Display', serif; margin: 0; letter-spacing: 1px; }
        
        .logout-btn { background: #111; border: 1px solid #ff4d4d; color: #ff4d4d; padding: 10px 20px; cursor: pointer; font-weight: bold; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .logout-btn:hover { background: #ff4d4d; color: white; }

        /* --- CEO STATS BAR --- */
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: #111; border: 1px solid #333; padding: 25px; border-radius: 12px; text-align: center; position: relative; overflow: hidden; }
        .stat-card p { color: #888; font-size: 0.75rem; margin: 0; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; }
        .stat-card h2 { color: white; margin: 15px 0 0 0; font-size: 2.2rem; font-family: 'Times New Roman', serif; }
        
        .gold-card { border-color: #C5A059; background: linear-gradient(135deg, #111 0%, #1a1500 100%); }
        .gold-card h2 { color: #C5A059; }
        .gold-card::after { content: "‚Çπ"; position: absolute; right: -10px; bottom: -20px; font-size: 100px; color: rgba(197, 160, 89, 0.05); font-family: serif; pointer-events: none; }

        /* --- GRID LAYOUT --- */
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; max-width: 1400px; margin: 0 auto; }

        .panel { background: #111; border: 1px solid #333; border-radius: 15px; padding: 25px; box-shadow: 0 0 20px rgba(0,0,0,0.5); height: fit-content; }
        .panel h2 { color: #C5A059; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; font-size: 1.2rem; }

        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        input:focus, textarea:focus { border-color: #C5A059; outline: none; }
        textarea { height: 80px; resize: vertical; font-family: sans-serif; }

        .action-btn { width: 100%; padding: 12px; margin-top: 10px; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; text-transform: uppercase; transition: 0.2s; }
        .btn-gold { background: #C5A059; color: black; }
        .btn-gold:hover { background: white; }
        .btn-refresh { background: #333; color: white; border: 1px solid #555; }
        .btn-refresh:hover { background: #444; }

        .inv-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; }
        .toggle-btn { padding: 5px; border: 1px solid #444; background: #222; color: #666; cursor: pointer; font-size: 0.75rem; border-radius: 4px; transition: 0.2s; }
        
        .active-sale { background: #C5A059 !important; color: black !important; border-color: #C5A059 !important; font-weight: bold; }
        .active-sold { background: #ff4d4d !important; color: white !important; border-color: #ff4d4d !important; font-weight: bold; }
        
        .img-btn { background: #333; color: white; border: 1px solid #555; padding: 5px; cursor: pointer; font-size: 0.75rem; border-radius: 4px; }
        .img-btn:hover { background: #444; }

        .scroll-box { max-height: 500px; overflow-y: auto; padding-right: 5px; margin-top: 15px; }
        .scroll-box::-webkit-scrollbar { width: 5px; }
        .scroll-box::-webkit-scrollbar-thumb { background: #333; border-radius: 5px; }

        .list-item { background: #1a1a1a; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #333; transition: 0.2s; }
        .list-item:hover { border-color: #555; }
        .list-item img { width: 60px; height: 60px; border-radius: 5px; object-fit: cover; margin-right: 15px; border: 1px solid #333; }
        
        .file-upload-wrapper { border: 2px dashed #444; padding: 20px; text-align: center; border-radius: 10px; margin: 10px 0; cursor: pointer; transition: 0.3s; position: relative; }
        .file-upload-wrapper:hover { border-color: #C5A059; background: rgba(197, 160, 89, 0.1); }
        .preview-img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; margin-top: 10px; display: none; border: 1px solid #C5A059; }

        .banner-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; min-height: 100px; }
        .banner-item { background: #222; border: 1px solid #444; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .banner-item img { width: 100%; height: 80px; object-fit: cover; }
        .banner-del { width: 100%; background: #ff4d4d; color: white; border: none; cursor: pointer; padding: 8px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .banner-del:hover { background: red; }

        /* ORDER BUTTONS */
        .order-btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn-track { background: #333; border: 1px solid #555; color: #C5A059; flex: 2; cursor: pointer; padding: 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
        .btn-confirm { background: #25D366; border: none; color: black; flex: 1; cursor: pointer; padding: 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
        .btn-delete { background: #ff4d4d; border: none; color: white; flex: 1; cursor: pointer; padding: 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }

        /* LOGISTICS PANEL */
        .logistics-panel { background: rgba(255,255,255,0.05); border: 1px solid #444; padding: 10px; margin-top: 10px; border-radius: 5px; }
        .live-link { display: flex; align-items: center; justify-content: space-between; color: #25D366; font-size: 0.8rem; font-weight: bold; }
        .live-link a { color: #fff; text-decoration: underline; margin-left: 10px; }

        /* COUPON LIST ITEM */
        .coupon-item { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 10px; border: 1px solid #444; border-radius: 5px; margin-bottom: 5px; }
        .coupon-code { color: #C5A059; font-weight: bold; font-size: 1.1rem; }
        .coupon-disc { color: #fff; font-size: 0.9rem; }

        /* CUSTOM MODAL */
        .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; }
        .modal-box { background: #111; padding: 30px; border-radius: 10px; border: 1px solid #C5A059; text-align: center; max-width: 400px; width: 90%; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
        .modal-yes { background: #ff4d4d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .modal-no { background: #333; color: white; border: 1px solid #555; padding: 10px 20px; border-radius: 5px; cursor: pointer; }

        /* GALLERY MANAGER STYLES (NEW) */
        .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .gallery-item { position: relative; }
        .gallery-item img { width: 100%; height: 80px; object-fit: cover; border-radius: 5px; border: 1px solid #333; }
        .gallery-del-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border: 1px solid white; cursor: pointer; font-size: 10px; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

    </style>
</head>
<body>

    <div id="confirmModal" class="custom-modal">
        <div class="modal-box">
            <h3 style="margin-top:0;">‚ö†Ô∏è Are you sure?</h3>
            <p id="modal-msg" style="color:#ccc; font-size:0.9rem;">This action cannot be undone.</p>
            <div class="modal-btns">
                <button id="modal-cancel-btn" class="modal-no">Cancel</button>
                <button id="modal-confirm-btn" class="modal-yes">Yes, Delete</button>
            </div>
        </div>
    </div>

    <div id="galleryModal" class="custom-modal">
        <div class="modal-box" style="max-width: 500px;">
            <h3 style="margin-top:0; color:#C5A059;">Manage Product Photos</h3>
            <p style="font-size:0.8rem; color:#888;">Tap 'X' to delete an extra image.</p>
            <div id="gallery-content" class="gallery-grid"></div>
            <button onclick="document.getElementById('galleryModal').style.display='none'" class="action-btn btn-refresh" style="margin-top:20px;">Close Manager</button>
        </div>
    </div>

    <div id="loading-screen">
        <h2>üîí Verifying Credentials...</h2>
        <p style="color:#666; font-size:0.8rem; margin-top:10px;">Please wait...</p>
        <button onclick="window.location.href='admin-login.html'" style="margin-top:20px; background:none; border:1px solid #555; color:#888; padding:5px 10px; cursor:pointer;">Stuck? Click to Login Again</button>
    </div>

    <input type="file" id="inventory-upload" accept="image/*" style="display:none" onchange="processInventoryImage(event)">

    <div id="admin-container">
        
        <div class="admin-header">
            <h1>ADMIN DASHBOARD</h1>
            <button onclick="adminLogout()" class="logout-btn">LOGOUT üîí</button>
        </div>

        <div class="stats-bar">
            <div class="stat-card gold-card">
                <p>Lifetime Revenue</p>
                <h2 id="ceo-revenue">‚Çπ0</h2>
            </div>
            <div class="stat-card">
                <p>Total Orders</p>
                <h2 id="ceo-orders">0</h2>
            </div>
            <div class="stat-card">
                <p>Pending Action</p>
                <h2 id="ceo-pending" style="color:#ff4d4d;">0</h2>
            </div>
        </div>

        <div class="admin-grid">
            
            <div class="panel">
                <h2>‚ûï Add New Product</h2>
                <div class="file-upload-wrapper" onclick="document.getElementById('file-input').click()">
                    <p id="upload-text" style="margin:0; color:#888;">üìÇ Click to Choose Main Image</p>
                    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleNewProductFile(event)">
                    <img id="preview" class="preview-img">
                </div>
                <input type="hidden" id="p-img-data">
                
                <input type="text" id="p-name" placeholder="Product Name">
                <input type="number" id="p-price" placeholder="Price (‚Çπ)">
                <textarea id="p-desc" placeholder="Product Description..."></textarea>
                
                <label style="color:#888; font-size:0.8rem; display:block; margin-top:10px;">Main Category</label>
                <select id="p-cat">
                    <option value="clothing">Clothing (Pherans, Shawls)</option>
                    <option value="accessories">Accessories (Bags, Jewelry)</option>
                    <option value="men">Men's Collection</option>
                </select>

                <label style="color:#888; font-size:0.8rem; display:block; margin-top:10px;">Sub-Category</label>
                <select id="p-subcat">
                    <option value="pherans">Pherans</option>
                    <option value="shawls">Shawls</option>
                    <option value="bags">Bags</option>
                    <option value="men">Men</option>
                    <option value="other">Other</option>
                </select>
                
                <div style="margin: 15px 0; display:flex; gap:20px;">
                    <label style="cursor:pointer;"><input type="checkbox" id="p-sale"> On Sale</label>
                    <label style="cursor:pointer;"><input type="checkbox" id="p-sold"> Sold Out</label>
                </div>
                
                <button onclick="uploadProduct()" id="btn-upload" class="action-btn btn-gold">Upload Product</button>
            </div>

            <div class="panel">
                <h2>üì¢ Shop Announcement</h2>
                <label style="color:#888; font-size:0.8rem;">Top Banner Message</label>
                <input type="text" id="ann-text" placeholder="e.g. Flash Sale: 50% Off!">
                
                <div style="display:flex; align-items:center; gap:10px; margin:15px 0;">
                    <label class="switch" style="display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" id="ann-active" style="width:auto; margin-right:10px;">
                        <span>Show Banner on Website</span>
                    </label>
                </div>
                
                <button onclick="saveAnnouncement()" class="action-btn btn-gold">Update Banner</button>
            </div>

            <div class="panel">
                <h2>üéüÔ∏è Coupon Manager</h2>
                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px;">
                    <input type="text" id="coup-code" placeholder="Code (SALE10)" style="text-transform:uppercase;">
                    <input type="number" id="coup-disc" placeholder="% Off">
                    <input type="number" id="coup-limit" placeholder="Limit/User" value="1">
                </div>
                <button onclick="addCoupon()" class="action-btn btn-refresh" style="margin-bottom:20px;">+ Add Coupon</button>
                
                <div id="coupon-list" class="scroll-box" style="height:200px;">
                    <p style="color:#666; text-align:center;">Loading coupons...</p>
                </div>
            </div>

            <div class="panel">
                <h2>üåç Home Backgrounds</h2>
                <button onclick="document.getElementById('bg-file-input').click()" class="action-btn btn-gold" style="margin-bottom:20px;">‚ûï Upload Photo</button>
                <input type="file" id="bg-file-input" accept="image/*" style="display:none" onchange="handleBgUpload(event)">
                
                <div id="banner-list" class="banner-grid scroll-box" style="min-height: 100px;">
                    <p style="color:#666; grid-column:1/-1; text-align:center;">Loading images...</p>
                </div>
            </div>

            <div class="panel">
                <h2>üìù Smart Inventory</h2>
                <button onclick="loadInventory()" class="action-btn btn-refresh">Refresh List</button>
                <div id="product-list" class="scroll-box">
                    <p style="color:#666; text-align:center; padding: 20px;">Loading products...</p>
                </div>
            </div>

            <div class="panel">
                <h2>üì¶ Recent Orders</h2>
                <button onclick="loadOrders()" class="action-btn btn-refresh">Refresh Orders</button>
                <div id="order-list" class="scroll-box">
                    <p style="color:#666; text-align:center; padding: 20px;">Loading orders...</p>
                </div>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                alert("Error: Firebase not initialized. Check firebase-config.js!");
                return;
            }

            const db = firebase.firestore();
            const auth = firebase.auth();
            const ADMIN_EMAIL = "poshakpanun@gmail.com"; 

            let currentEditId = null;
            let currentEditMode = null;
            
            // --- MODAL LOGIC ---
            let confirmCallback = null;
            const modal = document.getElementById('confirmModal');
            const modalMsg = document.getElementById('modal-msg');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            window.showConfirm = function(msg, callback) {
                modalMsg.innerText = msg;
                confirmCallback = callback;
                modal.style.display = 'flex';
            };

            cancelBtn.onclick = function() { modal.style.display = 'none'; confirmCallback = null; };
            confirmBtn.onclick = function() { if(confirmCallback) confirmCallback(); modal.style.display = 'none'; };

            // --- AUTH GUARD ---
            auth.onAuthStateChanged(user => {
                const loading = document.getElementById("loading-screen");
                const container = document.getElementById("admin-container");

                if (!user || user.email !== ADMIN_EMAIL) {
                    loading.innerHTML = '<h1 style="color:#ff4d4d;">‚õî ACCESS DENIED</h1><p>Redirecting...</p>';
                    setTimeout(() => { auth.signOut(); window.location.href = "admin-login.html"; }, 2000);
                } else {
                    loading.style.display = "none";
                    container.style.display = "block";
                    loadInventory();
                    loadOrders();
                    loadBanners();
                    calculateCEOStats();
                    loadAnnouncement(); 
                    loadCoupons();
                }
            });

            window.adminLogout = function() {
                showConfirm("Log out of Admin Dashboard?", () => {
                     auth.signOut().then(() => window.location.href="index.html");
                });
            };

            // --- CEO STATS LOGIC ---
            window.calculateCEOStats = function() {
                db.collection("orders").get().then(snap => {
                    let totalRevenue = 0;
                    let totalOrders = 0;
                    let pendingOrders = 0;

                    snap.forEach(doc => {
                        const o = doc.data();
                        totalOrders++;
                        if(o.status !== 'Cancelled') {
                            const price = Number(o.price || 0);
                            totalRevenue += price;
                        }
                        if(o.status === 'Placed') {
                            pendingOrders++;
                        }
                    });

                    document.getElementById("ceo-revenue").innerText = "‚Çπ" + totalRevenue.toLocaleString();
                    document.getElementById("ceo-orders").innerText = totalOrders;
                    document.getElementById("ceo-pending").innerText = pendingOrders;
                });
            };

            // --- UTILITIES ---
            function processFile(file, callback) {
                if (!file) return;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement("canvas");
                        const ctx = canvas.getContext("2d");
                        const maxWidth = 800; 
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        callback(canvas.toDataURL("image/jpeg", 0.7)); 
                    }
                }
            }

            // --- BANNERS ---
            window.handleBgUpload = function(event) {
                processFile(event.target.files[0], (dataUrl) => {
                    db.collection("home_banners").add({
                        img: dataUrl,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => { alert("Background Uploaded!"); loadBanners(); });
                });
            };

            window.loadBanners = function() {
                const list = document.getElementById("banner-list");
                list.innerHTML = "<p style='color:#888; text-align:center;'>Fetching...</p>"; 

                db.collection("home_banners").orderBy("timestamp", "desc").get()
                .then(snap => {
                    list.innerHTML = "";
                    if(snap.empty) { list.innerHTML = "<p style='color:#666; grid-column:1/-1; text-align:center;'>No banners found.</p>"; return; }
                    snap.forEach(doc => {
                        list.innerHTML += `
                            <div class="banner-item">
                                <img src="${doc.data().img}" onerror="this.src='https://via.placeholder.com/80?text=Error'">
                                <button class="banner-del" onclick="deleteBanner('${doc.id}')">DELETE</button>
                            </div>
                        `;
                    });
                });
            };

            window.deleteBanner = function(id) {
                showConfirm("Permanently delete this background?", () => {
                    db.collection("home_banners").doc(id).delete().then(loadBanners);
                });
            };

            // --- PRODUCTS ---
            window.handleNewProductFile = function(event) {
                processFile(event.target.files[0], (dataUrl) => {
                    document.getElementById("preview").src = dataUrl;
                    document.getElementById("preview").style.display = "inline-block";
                    document.getElementById("p-img-data").value = dataUrl;
                    document.getElementById("upload-text").innerText = "‚úÖ Image Ready";
                });
            };

            window.uploadProduct = function() {
                const btn = document.getElementById("btn-upload");
                const name = document.getElementById("p-name").value;
                const price = document.getElementById("p-price").value;
                const imgData = document.getElementById("p-img-data").value;

                if(!name || !price || !imgData) return alert("Please fill Name, Price and Image.");

                btn.innerText = "Uploading...";
                btn.disabled = true;

                db.collection("products").add({
                    name: name,
                    price: Number(price),
                    img: imgData,
                    description: document.getElementById("p-desc").value,
                    category: document.getElementById("p-cat").value,
                    subCategory: document.getElementById("p-subcat").value,
                    sale: document.getElementById("p-sale").checked,
                    soldOut: document.getElementById("p-sold").checked,
                    images: [imgData],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert("Product Added Successfully!");
                    loadInventory();
                    document.getElementById("p-name").value = "";
                    document.getElementById("p-price").value = "";
                    document.getElementById("p-desc").value = "";
                    document.getElementById("preview").style.display = "none";
                    document.getElementById("upload-text").innerText = "üìÇ Click to Choose Image";
                    btn.innerText = "Upload Product";
                    btn.disabled = false;
                }).catch(err => {
                    alert("Upload failed: " + err.message);
                    btn.innerText = "Upload Product";
                    btn.disabled = false;
                });
            };

            window.loadInventory = function() {
                const list = document.getElementById("product-list");
                list.innerHTML = "<p style='text-align:center; color:#666;'>Refreshing...</p>";

                db.collection("products").orderBy("timestamp", "desc").get().then(snap => {
                    list.innerHTML = "";
                    if(snap.empty) { list.innerHTML = "<p style='text-align:center; color:#666;'>No products found.</p>"; return; }

                    snap.forEach(doc => {
                        const p = doc.data();
                        const sClass = p.sale ? 'active-sale' : '';
                        const oClass = p.soldOut ? 'active-sold' : '';
                        const safeN = p.name ? p.name.replace(/'/g, "\\'") : "";

                        list.innerHTML += `
                            <div class="list-item">
                                <div style="display:flex; align-items:flex-start;">
                                    <img src="${p.img}" onerror="this.src='https://via.placeholder.com/60'">
                                    <div style="flex:1;">
                                        <h4 style="margin:0; color:#eee;">${p.name}</h4>
                                        <p style="margin:2px 0; color:#888;">‚Çπ${p.price}</p>
                                        
                                        <div class="inv-controls">
                                            <button onclick="toggleStatus('${doc.id}', 'sale', ${p.sale})" class="toggle-btn ${sClass}">${p.sale ? 'ON SALE' : 'Set Sale'}</button>
                                            <button onclick="toggleStatus('${doc.id}', 'soldOut', ${p.soldOut})" class="toggle-btn ${oClass}">${p.soldOut ? 'SOLD OUT' : 'Set Sold'}</button>
                                            <button onclick="triggerImageEdit('${doc.id}', 'replace')" class="img-btn">üì∑ Change Main</button>
                                            <button onclick="triggerImageEdit('${doc.id}', 'add_gallery')" class="img-btn" style="color:#C5A059; border-color:#C5A059;">‚ûï Add Photos</button>
                                        </div>

                                        <div style="display:flex; gap:5px; margin-top:5px;">
                                            <button onclick="openGalleryManager('${doc.id}')" class="img-btn" style="flex:1; border-color:#ff4d4d; color:#ff4d4d;">üñºÔ∏è Del Photos</button>
                                            <button onclick="editDescription('${doc.id}')" class="action-btn btn-refresh" style="flex:1; margin-top:0; font-size:0.75rem; padding:6px;">üìù Edit Desc</button>
                                        </div>

                                        <button onclick="deleteProduct('${doc.id}', '${safeN}')" style="width:100%; margin-top:8px; padding:6px; background:none; border:1px solid #333; color:#666; cursor:pointer; border-radius:4px; font-size:0.7rem;">
                                            üóëÔ∏è DELETE PRODUCT
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                });
            };

            window.deleteProduct = function(id, name) {
                showConfirm(`Delete "${name}"?`, () => {
                    db.collection("products").doc(id).delete().then(loadInventory);
                });
            };

            window.toggleStatus = function(id, field, currentValue) {
                let update = {};
                update[field] = !currentValue;
                db.collection("products").doc(id).update(update).then(loadInventory);
            };
            
            // --- EDIT DESCRIPTION FUNCTION ---
            window.editDescription = function(id) {
                db.collection("products").doc(id).get().then(doc => {
                    const currentDesc = doc.data().description || "";
                    const newDesc = prompt("Edit product description:", currentDesc);
                    if(newDesc !== null) {
                        db.collection("products").doc(id).update({ description: newDesc }).then(() => {
                            alert("Description Updated!");
                            loadInventory();
                        });
                    }
                });
            };

            window.triggerImageEdit = function(id, mode) {
                currentEditId = id;
                currentEditMode = mode;
                document.getElementById("inventory-upload").click();
            };

            window.processInventoryImage = function(event) {
                processFile(event.target.files[0], (dataUrl) => {
                    if(currentEditMode === 'replace') {
                        db.collection("products").doc(currentEditId).update({ 
                            img: dataUrl
                        }).then(() => { alert("Main Image Updated!"); loadInventory(); });
                    } else if (currentEditMode === 'add_gallery') {
                        db.collection("products").doc(currentEditId).update({ 
                            images: firebase.firestore.FieldValue.arrayUnion(dataUrl)
                        }).then(() => { alert("Extra Photo Added!"); loadInventory(); });
                    }
                    document.getElementById("inventory-upload").value = "";
                });
            };

            // --- ANNOUNCEMENT LOGIC ---
            window.loadAnnouncement = function() {
                db.collection('settings').doc('announcement').get().then(doc => {
                    if(doc.exists) {
                        const data = doc.data();
                        document.getElementById('ann-text').value = data.text || "";
                        document.getElementById('ann-active').checked = data.isActive || false;
                    }
                });
            };

            window.saveAnnouncement = function() {
                const text = document.getElementById('ann-text').value;
                const active = document.getElementById('ann-active').checked;
                db.collection('settings').doc('announcement').set({
                    text: text,
                    isActive: active
                }).then(() => alert("Announcement Updated!"));
            };

            // --- COUPON MANAGER ---
            window.loadCoupons = function() {
                const list = document.getElementById("coupon-list");
                list.innerHTML = "<p style='color:#666; text-align:center;'>Loading...</p>";
                db.collection('coupons').get().then(snap => {
                    list.innerHTML = "";
                    if(snap.empty) { list.innerHTML = "<p style='color:#666; text-align:center;'>No active coupons.</p>"; return; }
                    snap.forEach(doc => {
                        const data = doc.data();
                        const limitText = data.limitPerUser ? ` (Limit: ${data.limitPerUser})` : " (Unlimited)";
                        list.innerHTML += `
                            <div class="coupon-item">
                                <div>
                                    <div class="coupon-code">${doc.id}</div>
                                    <div class="coupon-disc">${data.percent}% Off ${limitText}</div>
                                </div>
                                <button onclick="deleteCoupon('${doc.id}')" class="banner-del" style="width:auto; padding:5px 10px;">Delete</button>
                            </div>
                        `;
                    });
                });
            };

            window.addCoupon = function() {
                const code = document.getElementById('coup-code').value.trim().toUpperCase();
                const disc = Number(document.getElementById('coup-disc').value);
                const limit = Number(document.getElementById('coup-limit').value) || 1;

                if(!code || !disc) return alert("Enter Code and Discount %");
                
                db.collection('coupons').doc(code).set({
                    percent: disc,
                    limitPerUser: limit,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert("Coupon Added!");
                    document.getElementById('coup-code').value = "";
                    document.getElementById('coup-disc').value = "";
                    document.getElementById('coup-limit').value = "1";
                    loadCoupons();
                });
            };

            window.deleteCoupon = function(code) {
                if(confirm("Delete coupon " + code + "?")) {
                    db.collection('coupons').doc(code).delete().then(loadCoupons);
                }
            };

            // --- ORDERS (WITH ORDER ID DISPLAY) ---
            window.loadOrders = function() {
                const list = document.getElementById("order-list");
                list.innerHTML = "<p style='color:#888; text-align:center;'>Fetching Orders...</p>";

                db.collection("orders").orderBy("timestamp", "desc").limit(50).get()
                .then(snap => {
                    list.innerHTML = "";
                    if(snap.empty) { list.innerHTML = "<p style='text-align:center; color:#666;'>No orders yet.</p>"; return; }

                    snap.forEach(doc => {
                        const o = doc.data();
                        
                        // --- ORDER ID GENERATION ---
                        const orderID = "#" + doc.id.toUpperCase().slice(0, 8);
                        
                        let statusColor = '#888';
                        if(o.status === 'Confirmed') statusColor = '#25D366'; 
                        if(o.status === 'Shipped') statusColor = '#C5A059'; 
                        
                        let utrInfo = "";
                        if(o.paymentMethod === 'upi') {
                            utrInfo = `<p style="color:#C5A059; font-size:0.8rem;">UTR: ${o.transactionId || 'Pending'}</p>`;
                        }

                        let logisticsPanel = "";
                        if(o.trackingUrl) {
                            logisticsPanel = `
                                <div class="logistics-panel">
                                    <div class="live-link">
                                        <span>‚úì Live Link Active</span>
                                        <a href="${o.trackingUrl}" target="_blank">Test Link</a>
                                    </div>
                                </div>
                            `;
                        } else {
                            logisticsPanel = `
                                <button onclick="addPartnerLink('${doc.id}')" class="btn-track" style="margin-top:10px; width:100%; border:1px dashed #666; background:transparent;">üîó Connect Partner</button>
                            `;
                        }

                        const trackingLink = `${window.location.origin}${window.location.pathname.replace('admin.html', '')}tracker.html?id=${o.trackingId || doc.id}`;

                        list.innerHTML += `
                            <div class="list-item">
                                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px;">
                                    <span style="font-size:0.75rem; color:#C5A059; font-weight:bold;">ID: ${orderID}</span>
                                    <h4 style="margin:0; color:${statusColor}">${o.status || 'Placed'}</h4>
                                </div>
                                
                                <div style="display:flex; justify-content:space-between;">
                                    <p style="margin:5px 0;"><strong>${o.product}</strong></p>
                                    <small style="color:#666;">${o.timestamp ? new Date(o.timestamp.seconds * 1000).toLocaleDateString() : ''}</small>
                                </div>
                                <p style="margin:0; color:#aaa;">‚Çπ${o.price} | User: ${o.customer ? o.customer.name : 'Guest'}</p>
                                ${utrInfo}
                                
                                ${logisticsPanel}

                                <div class="order-btn-group">
                                    <button onclick="copyToClipboard('${trackingLink}')" class="btn-track">üîó Copy Tracking</button>
                                    <button onclick="updateOrder('${doc.id}', 'Confirmed')" class="btn-confirm">‚úì Confirm</button>
                                    <button onclick="deleteOrder('${doc.id}')" class="btn-delete">üóë Delete</button>
                                </div>
                                
                                <div style="margin-top:5px; font-size:0.7rem; text-align:right;">
                                    <span style="cursor:pointer; color:#666;" onclick="updateOrder('${doc.id}', 'Shipped')">Mark Shipped</span> | 
                                    <span style="cursor:pointer; color:#666;" onclick="updateOrder('${doc.id}', 'Delivered')">Mark Delivered</span>
                                </div>
                            </div>
                        `;
                    });
                });
            };

            // --- GALLERY MANAGER LOGIC ---
            window.openGalleryManager = function(id) {
                const modal = document.getElementById('galleryModal');
                const content = document.getElementById('gallery-content');
                content.innerHTML = "Loading...";
                modal.style.display = 'flex';

                db.collection("products").doc(id).get().then(doc => {
                    const p = doc.data();
                    const images = p.images || [];
                    content.innerHTML = "";
                    if(images.length === 0) { content.innerHTML = "<p style='grid-column:1/-1; color:#666; text-align:center;'>No extra photos found.</p>"; return; }

                    images.forEach(url => {
                        content.innerHTML += `
                            <div class="gallery-item">
                                <img src="${url}">
                                <button class="gallery-del-btn" onclick="deleteGalleryImage('${id}', '${url}')">X</button>
                            </div>
                        `;
                    });
                });
            }

            window.deleteGalleryImage = function(id, url) {
                if(confirm("Delete this photo from gallery?")) {
                     db.collection("products").doc(id).update({
                         images: firebase.firestore.FieldValue.arrayRemove(url)
                     }).then(() => {
                         openGalleryManager(id); 
                         loadInventory(); 
                     });
                }
            }

            window.addPartnerLink = function(id) {
                const link = prompt("Paste the Partner Tracking Link (BlueDart, Delhivery, etc.):");
                if(link) {
                    db.collection("orders").doc(id).update({ trackingUrl: link }).then(() => {
                        alert("Partner Connected!");
                        loadOrders();
                    });
                }
            };

            window.copyToClipboard = function(text) {
                navigator.clipboard.writeText(text).then(() => { alert("Tracking Link Copied!"); });
            };

            window.updateOrder = function(id, status) {
                db.collection('orders').doc(id).update({status: status}).then(() => { loadOrders(); calculateCEOStats(); });
            };

            window.deleteOrder = function(id) {
                showConfirm("Delete this order? (Cannot be undone)", () => {
                    db.collection('orders').doc(id).delete().then(() => { loadOrders(); calculateCEOStats(); });
                });
            };
        });
    </script>
</body>
</html>
